exports.encode = function (frase, senha) {
  let espacos = contadorEspaco(frase)
  let fraseSeparada = lerFrase(frase)
  let frasePares = dicionarioLetras(fraseSeparada)
  let fraseEncriptada = encriptar(frasePares, senha)
  let fraseFinal = dicionarioNumeros(fraseEncriptada)
  resultado = {'fraseFinal' : fraseFinal, 'espacos' : espacos}
  return resultado
}
exports.decode = function (frase, senha, espacos) {
  let fraseSeparada = lerFrase(frase)
  let senhaInvertida = inverteMatriz(senha)
  let determinante = calculaDet(senha)
  let inverso = achaInverso(determinante)
  let senhaMod26 = inversoModular(senhaInvertida, inverso)
  let frasePares = dicionarioLetras(fraseSeparada)
  let fraseDecriptada = encriptar(frasePares, senhaMod26)
  let fraseFinal = dicionarioNumeros(fraseDecriptada)
  fraseFinal = formataFrase(fraseFinal, espacos)
  return fraseFinal
}


exports.cifraCesar = function (frase, passo) {
  let numbers = {
      1: 'a',
      2: 'b',
      3: 'c',
      4: 'd',
      5: 'e',
      6: 'f',
      7: 'g',
      8: 'h',
      9: 'i',
      10: 'j',
      11: 'k',
      12: 'l',
      13: 'm',
      14: 'n',
      15: 'o',
      16: 'p',
      17: 'q',
      18: 'r',
      19: 's',
      20: 't',
      21: 'u',
      22: 'v',
      23: 'w',
      24: 'x',
      25: 'y',
      0: 'z'
  }
  let result = {
      'a': 1,
      'b': 2,
      'c': 3,
      'd': 4,
      'e': 5,
      'f': 6,
      'g': 7,
      'h': 8,
      'i': 9,
      'j': 10,
      'k': 11,
      'l': 12,
      'm': 13,
      'n': 14,
      'o': 15,
      'p': 16,
      'q': 17,
      'r': 18,
      's': 19,
      't': 20,
      'u': 21,
      'v': 22,
      'w': 23,
      'x': 24,
      'y': 25,
      'z': 0
  }
  let arrayCifrado = []
  let fraseCifrada = ""
  for (let i = 0; i < frase.length; i++) {
      if (frase[i] == " ") {
          arrayCifrado.push(-1)
      } else {
          arrayCifrado.push(result[frase[i]])
      }
  }
  for (let i = 0; i < arrayCifrado.length; i++) {
      if (arrayCifrado[i] != -1) {
          arrayCifrado[i] = arrayCifrado[i] + passo
      }
  }
  for (let i = 0; i < arrayCifrado.length; i++) {
      if (arrayCifrado[i] == -1) {
          fraseCifrada += " "
      } else {
          fraseCifrada += numbers[arrayCifrado[i] % 26]
      }
  }
  return fraseCifrada
}

function calculaDet(matriz) {
  let determinante = matriz[0][0] * matriz[1][1] - (matriz[0][1] * matriz[1][0])
  return determinante
}

function contadorEspaco(frase) {
  let whitespace = []
  for (let i = 0; i < frase.length; i++) {
      if (frase[i] == " ") {
          whitespace.push(i)
      }
  }
  return whitespace
}

function lerFrase(frase) {
  let arrayFrase
  frase = frase.toLowerCase().replace(/\s/g, "")
  if (frase.length % 2 != 0) {
      frase += frase[frase.length - 1]
  }
  arrayFrase = frase.match(/.{1,2}/g)
  return arrayFrase
}

function dicionarioLetras(matrizNumeros) {
  let result = {
      'a': 1,
      'b': 2,
      'c': 3,
      'd': 4,
      'e': 5,
      'f': 6,
      'g': 7,
      'h': 8,
      'i': 9,
      'j': 10,
      'k': 11,
      'l': 12,
      'm': 13,
      'n': 14,
      'o': 15,
      'p': 16,
      'q': 17,
      'r': 18,
      's': 19,
      't': 20,
      'u': 21,
      'v': 22,
      'w': 23,
      'x': 24,
      'y': 25,
      'z': 0
  }
  let matrizLetras = []
  let aux = []
  for (let i = 0; i < matrizNumeros.length; i++) {
      for (let j = 0; j < matrizNumeros[i].length; j++) {
          aux.push(result[matrizNumeros[i][j]])
      }
      matrizLetras.push(aux)
      aux = []
  }
  return matrizLetras
}

function encriptar(matrizesFrase, senha) {
  let matrizEncriptada = []
  let aux = []
  for (let i = 0, j = 0; i < matrizesFrase.length; i++) {
      aux.push(matrizesFrase[i][0] * senha[0][0] + matrizesFrase[i][1] * senha[0][1])
      aux.push(matrizesFrase[i][0] * senha[1][0] + matrizesFrase[i][1] * senha[1][1])
      matrizEncriptada.push(aux)
      aux = []
  }
  return matrizEncriptada
}

function dicionarioNumeros(matrizLetras) {
  let numbers = {
      1: 'a',
      2: 'b',
      3: 'c',
      4: 'd',
      5: 'e',
      6: 'f',
      7: 'g',
      8: 'h',
      9: 'i',
      10: 'j',
      11: 'k',
      12: 'l',
      13: 'm',
      14: 'n',
      15: 'o',
      16: 'p',
      17: 'q',
      18: 'r',
      19: 's',
      20: 't',
      21: 'u',
      22: 'v',
      23: 'w',
      24: 'x',
      25: 'y',
      0: 'z'
  }
  let resultado = ""
  for (let i = 0; i < matrizLetras.length; i++) {
      for (let j = 0; j < matrizLetras[i].length; j++) {
          resultado += numbers[matrizLetras[i][j] % 26]
      }
  }
  return resultado
}

function inverteMatriz(matriz) {
  let aux = []
  for (let i = 0; i < matriz.length; i++) {
      for (let j = 0; j < matriz.length; j++) {
          if (i == j) {
              aux.push(matriz[i][j])
          } else {
              matriz[i][j] = matriz[i][j] * (-1)
          }
      }
  }
  for (let i = 0; i < matriz.length; i++) {
      for (let j = 0; j < matriz.length; j++) {
          if (i == j) {
              matriz[i][j] = aux[matriz.length - 1 - i]
          }
      }
  }
  return matriz
}

function achaInverso(determinante) {
  let inverso
  let achou = false
  for (let i = 1; i < 26 && !achou; i++) {
      if ((i * determinante) % 26 == 1) {
          inverso = i
          achou = true
      }
  }
  return inverso
}

function inversoModular(matrizInversa, inverso) {
  for (let i = 0; i < matrizInversa.length; i++) {
      for (let j = 0; j < matrizInversa[i].length; j++) {
          matrizInversa[i][j] *= inverso
          matrizInversa[i][j] = matrizInversa[i][j] % 26
          if (matrizInversa[i][j] < 0) {
              matrizInversa[i][j] += 26
          }
      }
  }
  return matrizInversa
}

function formataFrase(frase, whitespace) {
  if (frase[frase.length - 1] == frase[frase.length - 2]) {
      frase = frase.slice(0, frase.length - 1)
  }
  for (let i = 0; i < whitespace.length; i++) {
      frase = frase.substring(0, whitespace[i]) + " " + frase.substring(whitespace[i], frase.length)
  }
  return frase
}